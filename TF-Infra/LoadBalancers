###################
## Load Balancer ##
###################
resource "azurerm_public_ip" "default" {
  name                = "psykprjspip"
  location            = var.location
  resource_group_name = var.resource_group_name
  allocation_method   = "Static"
  domain_name_label   = "psykprjsp20"
}

resource "azurerm_lb" "default" {
  name                = "psykprjslb"
  location            = var.location
  resource_group_name = var.resource_group_name

  frontend_ip_configuration {
    name                 = "psykprjsfe"
    public_ip_address_id = azurerm_public_ip.default.id
  }
}

resource "azurerm_lb_backend_address_pool" "default" {
  loadbalancer_id = azurerm_lb.default.id
  name            = "psykprjspool"
}

resource "azurerm_network_interface_backend_address_pool_association" "admin_nic" {
  count                   = 3
  network_interface_id    = azurerm_network_interface.admin_nic[count.index].id
  ip_configuration_name   = "ipconfig1"
  backend_address_pool_id = azurerm_lb_backend_address_pool.default.id
}

resource "azurerm_network_interface_backend_address_pool_association" "chattickting_nic" {
  network_interface_id    = azurerm_network_interface.chattickting_nic.id
  ip_configuration_name   = var.chattickting_ip
  backend_address_pool_id = azurerm_lb_backend_address_pool.default.id
}

resource "azurerm_network_interface_backend_address_pool_association" "gitlab_nic" {
  network_interface_id    = azurerm_network_interface.gitlab_nic.id
  ip_configuration_name   = var.gitlab_ip
  backend_address_pool_id = azurerm_lb_backend_address_pool.default.id
}

resource "azurerm_network_interface_backend_address_pool_association" "clearenceai_nic" {
  network_interface_id    = azurerm_network_interface.clearenceai_nic.id
  ip_configuration_name   = "ipconfig1"
  backend_address_pool_id = azurerm_lb_backend_address_pool.default.id
}

resource "azurerm_network_interface_backend_address_pool_association" "web_nic" {
  network_interface_id    = azurerm_network_interface.web_nic.id
  ip_configuration_name   = var.web_ip
  backend_address_pool_id = azurerm_lb_backend_address_pool.default.id
}

resource "azurerm_network_interface_backend_address_pool_association" "wiki_nic" {
  network_interface_id    = azurerm_network_interface.wiki_nic.id
  ip_configuration_name   = var.wiki_ip
  backend_address_pool_id = azurerm_lb_backend_address_pool.default.id
}